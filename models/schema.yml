version: 2

sources:
   - name: raw #Renaming as an alias
     schema: gz_raw_data #Path of the table in BQ
     description: greenweez raw data source #optionnal 
     tables:

         - name: sales #Renaming as an alias
           identifier: raw_gz_sales #What is the exact name of the table in  BQ
           description: sales of greewneez / we have one row per product_id found in each order_id
           #freshness testing
           loaded_at_field: "CAST(... AS TIMESTAMP)"
           freshness:
            warn_after: {count: 90, period: day}
           columns:
             - name: "(orders_id || '-' || pdt_id)"
               description: primary key of the table
               tests:
                 - unique
                 - not_null
             - name: date_date
               description: date of purchase
             - name: orders_id
               description: indvidual order identifier
             - name: pdt_id
               description: individual product identifier
             - name: revenue
               description: revenue generated by each order
             - name: quantity
               description: quantity of each product sold


         - name: product
           identifier: raw_gz_product
           description: purchase_price by products_id
           columns:
             - name: products_id
               description: primary key of the table
               tests:
                 - unique
                 - not_null
                 
         - name: ship
           identifier: raw_gz_ship
           description: ship_cost by orders_id
           columns:
             - name: orders_id
               description: primary key of the table
               tests:
                 - unique
                 - not_null

models:
        - name: int_sales_margin #dbt path
          description:  margin per product calculation #calculation
          columns:
            - name: "(orders_id || '-' || products_id)"
              description: primary key of the table
              tests:
                - unique
                - not_null

            - name: products_id
              tests:
                - not_null

            - name: date_date
              tests:
                - not_null

            - name: orders_id
              tests:
                - not_null

            - name: revenue
              tests:
                - not_null

            - name: quantity
              tests:
                - not_null

            - name: purchase_price
              tests:
                - not_null

            - name: margin
              tests:
                - not_null

            - name: purchase_cost
              tests:
                - not_null

        - name: int_orders_operational #we had to delete the order_id test because not null and unique on order id was returning duplicate and null value
          description: order level model
          columns:
           - name: date_date
             tests:
             - not_null
           - name: revenue
             tests:
               - not_null
           - name: purchase_cost
             tests:
               - not_null
           - name: margin
             tests:
               - not_null
           - name: shipping_fee
             tests:
               - not_null     
           - name: ship_cost
             tests:
               - not_null
           - name: operational_margin
             tests:
               - not_null      

        - name: int_orders_margin
          description: Calculate the Margin per Order
          columns:
           - name: orders_id
             description: primary key
             tests:
               - unique
               - not_null
           - name: date_date
             tests:
             - not_null
           - name: revenue
             tests:
               - not_null
           - name: quantity
             tests:
               - not_null
           - name: purchase_cost
             tests:
               - not_null
           - name: margin
             tests:
               - not_null    
      
        - name: finance_day 
          description: daily financial metrics
          columns:
             - name: date_date
               description: primary key of the table
               tests:
                 - unique
                 - not_null
             - name: tot_transactions
               tests:
                 - not_null
             - name: tot_revenue
               tests:
                 - not_null
             - name: average_basket
               tests:
                 - not_null
             - name: op_margin
               tests:
                 - not_null
             - name: tot_purchase_cost
               tests:
                 - not_null
             - name: tot_logcost
               tests:
                 - not_null
             - name: tot_quantity
               tests:
                 - not_null

        